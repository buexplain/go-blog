{{define "title"}}
    {{if .result}}新增{{else}}编辑{{end}}内容
{{end}}

{{define "css"}}
    <link rel="stylesheet" href="/resources/asset/layext/dtree/dtree.css">
    <link rel="stylesheet" href="/resources/asset/layext/dtree/font/dtreefont.css">
    <link rel="stylesheet" href="/resources/asset/layext/formSelects/formSelects-v4.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor@latest/dist/index.classic.css" />
    <script src="https://cdn.jsdelivr.net/npm/vditor@latest/dist/index.min.js"></script>
{{end}}

{{define "content"}}
    <form class="layui-form" id="j-form" action="{{if .result}}/backend/article/content/update/{{.result.ID}}{{else}}/backend/article/content{{end}}" method="{{if .result}}put{{else}}post{{end}}">
        <div class="layui-form-item">
            <div class="layui-inline" style="width: 30%;">
                <input type="text" name="title" value="{{.result.Title}}" lay-verify="required" placeholder="请填写标题" autocomplete="off" class="layui-input">
            </div>

            <div class="layui-inline">
                <ul id="j-category" class="dtree" data-id="0"></ul>
            </div>

            <div class="layui-inline" style="width: 20%">
                <div class="xm-select-demo" id="j-tags"></div>
            </div>

            <div class="layui-inline" style="width: 10%;">
                <div class="xm-select-demo" id="j-online"></div>
            </div>

            <div class="layui-inline">
                {{._token}}
                <button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-icon layui-icon-down" id="j-more-btn">
                    更多
                </button>
                <button class="layui-btn layui-btn-sm" lay-submit lay-filter="listen">
                    提交
                </button>
                <a href="/backend/article/content" class="layui-btn layui-btn-sm layui-btn-primary">
                    取消
                </a>
            </div>
        </div>

        <div class="layui-form-item" id="j-more">
            <div class="layui-inline" style="width: 30%;">
                <input type="text" name="coverPC" value="{{.result.CoverPC}}" placeholder="PC封面图片路径" autocomplete="off" class="layui-input">
            </div>

            <div class="layui-inline" style="width: 30%;">
                <input type="text" name="coverWap" value="{{.result.CoverWAP}}" placeholder="WAP封面图片路径" autocomplete="off" class="layui-input">
            </div>

            <div class="layui-inline" style="width: 30%;">
                <input type="text" name="origin" value="{{.result.Origin}}" placeholder="文章来源地址" autocomplete="off" class="layui-input">
            </div>
        </div>
    </form>
    <div id="j-editor"></div>
{{end}}

{{define "js"}}
    <script>
        var contentID = 28;

        layui.use(['form', 'layer', 'formSelects', 'jquery', 'xmSelect', 'dtree'], function() {
            var form = layui.form;
            var layer = layui.layer;
            var formSelects = layui.formSelects;
            var $ = layui.jquery;
            var xmSelect = layui.xmSelect;
            var dtree = layui.dtree;

            //获取内容
            var getContent = function () {
                return new Promise(function(resolve, reject) {
                    $.ajax({
                        url: "/backend/article/content/show/"+contentID,
                        async:true,
                        data: {},
                        type: "get",
                        success: function (json) {
                            if (json.code !== 0) {
                                reject(json.message);
                            } else {
                                resolve(json.data);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            reject(textStatus+errorThrown);
                        }
                    });
                });
            };

            //获取标签列表
            var getTagList = function () {
                return new Promise(function(resolve, reject) {
                    $.ajax({
                        url: "/backend/article/content/tag",
                        async:true,
                        data: {},
                        type: "get",
                        success: function (json) {
                            if (json.code !== 0) {
                                reject(json.message);
                            } else {
                                resolve(json.data);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            reject(textStatus+errorThrown);
                        }
                    });
                });
            };

            //获取分类列表
            var getCategoryList = function () {
                return new Promise(function(resolve, reject) {
                    $.ajax({
                        url: "/backend/article/content/category/-1",
                        async:true,
                        data: {},
                        type: "get",
                        success: function (json) {
                            if (json.code !== 0) {
                                reject(json.message);
                            } else {
                                resolve(json.data);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            reject(textStatus+errorThrown);
                        }
                    });
                });
            };

            Promise.all([getContent(), getCategoryList(), getTagList()]).then(function([content, categoryList, tagList]) {

                content.hasCategory = function(id) {
                    if(this.Category === null) {
                        return false;
                    }
                    return this.Category.some(function (v, k) {
                        return v.ID === id
                    });
                };

                content.hasTag = function(id) {
                    if(this.Tag === null) {
                        return false;
                    }
                    return this.Tag.some(function (v, k) {
                        return v.ID === id
                    });
                };

                categoryList.process = function() {
                    var result = [];
                    this.forEach(function (v, k) {
                        result.push({
                            "id":v.ID,
                            "title": v.Name,
                            "checkArr": [{
                                "type": "0", //type表示当前节点的第几个复选框
                                "checked": content.hasCategory(v.ID) ? '1' : '0' //0-未选中，1-选中，2-半选
                            }],
                            "parentId": v.Pid
                        });
                    });
                    return result;
                };

                tagList.process = function () {
                    var result = [];
                    this.forEach(function (v, k) {
                        result.push({name: v.Name, value: v.ID, selected: content.hasTag(v.ID)});
                    });
                    return result;
                };

                var online = [{ID:1, Name:'上线'}, {ID:2, Name:'下线'}];
                online.process = function () {
                    var result = [];
                    this.forEach(function (v, k) {
                        result.push({name: v.Name, value: v.ID, selected: content.Content.Online === v.ID});
                    });
                    return result;
                };

                return new Promise(function(resolve, reject) {
                    resolve({
                        content:content
                        ,categoryList:categoryList.process()
                        ,tagList:tagList.process()
                        ,online:online.process()
                    });
                });
            }).then(function (result) {
                console.log(result);

                //渲染分类
                dtree.render({
                    elem: "#j-category",
                    selectInputName:{nodeId: "category",  context: "categoryTitle"},
                    selectTips: "请选择分类",
                    accordion: true,  // 开启手风琴
                    select: true, //指定下拉树模式
                    width: "100%",
                    initLevel:2, //默认展开层级，当该值大于level时，则会展开树的节点，直到不大于当前待展开节点的level
                    dataFormat: "list", // 用于用户配置的data的数据格式,list:数组格式，levelRelationship：层级关系格式。
                    skin: "layui",  // laySimple主题风格
                    data: result.categoryList
                });

                //渲染标签
                const tag = xmSelect.render({
                    el: '#j-tags',
                    toolbar: {
                        show: true,
                    },
                    tips:'请选择标签',
                    filterable: true,
                    paging: true,
                    size: 'small',
                    pageSize: 10,
                    max: 3,
                    data: result.tagList,
                    create: function(val) {
                        console.log(val);
                        //返回一个创建成功的对象, val是搜索的数据
                        return {
                            name: '创建-' + val,
                            value: val
                        }
                    }
                });

                //渲染上下线
                const online = xmSelect.render({
                    el: '#j-online',
                    tips:'请选择上下线',
                    size: 'small',
                    radio: true,
                    clickClose: true,
                    data: result.online
                });

                //渲染编辑器
                const vEditor = new Vditor('j-editor', {
                    placeholder:'请输入文章内容',
                    cache:false,
                    counter: 65535,
                    height: $(window).height() - 93,
                    width:"100%",
                    tab: '\t',
                    upload: {
                        handler (file) {
                            var formData = new FormData();
                            formData.append('_token', document.querySelector("input[name=_token]").value);
                            for(var i in file) {
                                formData.append('file[]', file[i]);
                            }
                            var request = new XMLHttpRequest();
                            request.open("POST", "/backend/article/content/upload");
                            request.onload = function(oEvent) {
                                let currentTarget = oEvent.currentTarget;
                                if(currentTarget.status !== 200) {
                                    layer.alert(currentTarget.status+' '+currentTarget.statusText, {icon: 2});
                                    return '';
                                }
                                let json = JSON.parse(currentTarget.response);
                                if(json.code === 0) {
                                    var show = [".jpg", ".png", ".gif", ".jpeg", ".bmp"];
                                    for(var i in json.data) {
                                        var tmp = '['+json.data[i].name+']('+json.data[i].path+')';
                                        for(var j in show) {
                                            if(json.data[i].path.substr(0 - show[j].length).toLocaleLowerCase() === show[j]) {
                                                tmp = '!'+tmp;
                                                break;
                                            }
                                        }
                                        vEditor.insertValue(tmp);
                                    }
                                }else {
                                    layer.alert(json.message, {icon: 2});
                                }
                            };
                            request.send(formData);
                        },
                    },
                    preview: {
                        mode: 'both',
                        parse: (element) => {
                            LazyLoadImage()
                        },
                    },
                });
                vEditor.setValue(result.content.Content.Body);

                //提交表单
                form.on('submit(listen)', function(data) {
                    console.log(data.field);
                    return false;
                    //构造表单参数
                    var formData = new FormData();
                    for(var i in data.field) {
                        formData.append(i, data.field[i]);
                    }
                    formData.append('tags', )
                    //收集标签参数
                    var tags = formSelects.value('j-tags');
                    for(var i in tags) {
                        if(tags[i].value < 0) {
                            //新增的标签
                            formData.append('tagsName[]', tags[i].name);
                        }else {
                            //旧的标签
                            formData.append('tagsID[]', tags[i].value);
                        }
                    }
                    formData.append('body', vEditor.getValue());
                    var request = new XMLHttpRequest();
                    var f = $("#j-form");
                    request.open(f.attr('method'), f.attr('action'));
                    request.onload = function(oEvent) {
                        let currentTarget = oEvent.currentTarget;
                        if(currentTarget.status !== 200) {
                            layer.alert(currentTarget.status+' '+currentTarget.statusText, {icon: 2});
                            return '';
                        }
                        let json = JSON.parse(currentTarget.response);
                        if(json.code === 0) {
                            vEditor.clearCache();
                            layer.alert(json.message, {icon: 1});
                        }else {
                            layer.alert(json.message, {icon: 2});
                        }
                    };
                    request.send(formData);
                    return false;
                });
            }).catch(function (rej) {
                layer.alert(rej, {icon: 2});
            });

            const LazyLoadImage = () => {
                const loadImg = (it) => {
                    const testImage = document.createElement('img');
                    testImage.src = it.getAttribute('data-src');
                    testImage.addEventListener('load', () => {
                        it.src = testImage.src;
                        it.style.backgroundImage = 'none';
                        it.style.backgroundColor = 'transparent';
                    });
                    it.removeAttribute('data-src')
                };

                if (!('IntersectionObserver' in window)) {
                    document.querySelectorAll('img').forEach((data) => {
                        if (data.getAttribute('data-src')) {
                            loadImg(data)
                        }
                    });
                    return false
                }

                if (window.imageIntersectionObserver) {
                    window.imageIntersectionObserver.disconnect();
                    document.querySelectorAll('img').forEach(function (data) {
                        window.imageIntersectionObserver.observe(data)
                    });
                } else {
                    window.imageIntersectionObserver = new IntersectionObserver((entries) => {
                        entries.forEach((entrie) => {
                            if ((typeof entrie.isIntersecting === 'undefined'
                                ? entrie.intersectionRatio !== 0
                                : entrie.isIntersecting) && entrie.target.getAttribute('data-src')) {
                                loadImg(entrie.target)
                            }
                        })
                    });
                    document.querySelectorAll('img').forEach(function (data) {
                        window.imageIntersectionObserver.observe(data)
                    });
                }
            };
        });
    </script>

    <script type="text/javascript">
        //更多操作
        layui.use(['jquery'], function () {
            var $ = layui.jquery;
            var more = $("#j-more");
            more.hide();
            var moreBtn = $("#j-more-btn");
            moreBtn.on('click', function () {
                if(more.css('display') === 'none') {
                    more.show();
                    moreBtn.removeClass('layui-icon-down').addClass('layui-icon-up');
                }else{
                    more.hide();
                    moreBtn.removeClass('layui-icon-up').addClass('layui-icon-down');
                }
            });
        });
    </script>
{{end}}